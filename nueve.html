<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Horas</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:system-ui;background:#f2f2f2;margin:0;padding:10px}
h2{text-align:center}
form,table,.acciones{
  background:#fff;padding:10px;border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:12px
}
label{font-weight:600;font-size:14px}
input,textarea,button{
  width:100%;padding:8px;margin:5px 0 10px;
  border-radius:6px;border:1px solid #ccc
}
button{background:#007bff;color:#fff;font-weight:bold;border:none}
button.sec{background:#28a745}
button.danger{background:#dc3545}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:center}
th{background:#eee}
.total{font-size:18px;font-weight:bold;text-align:right}
.pago{color:green;font-weight:bold}
.historial{font-size:11px;color:#555;text-align:left}
.toggle{display:flex;align-items:center;gap:8px;margin-bottom:10px}
</style>
</head>

<body>

<h2>‚è±Ô∏è Control de Horas</h2>

<form id="form">
  <input type="hidden" id="editIndex">

  <label>Fecha</label>
  <input type="date" id="fecha" required>

  <label>Hora Inicio</label>
  <input type="time" id="inicio" required>

  <label>Hora Salida</label>
  <input type="time" id="salida" required>

  <label>Detalle</label>
  <textarea id="detalle"></textarea>

  <label>Valor por Hora (‚Ç°)</label>
  <input type="number" id="valorHora" value="2000">

  <button>üíæ Guardar Trabajo</button>
</form>

<div class="acciones">
  <div class="toggle">
    <input type="checkbox" id="soloPendientes" onchange="render()">
    <label for="soloPendientes">Mostrar solo pendientes</label>
  </div>
  <button class="sec" onclick="exportarExcel()">üìä Excel</button>
  <button class="sec" onclick="exportarPDF()">üìÑ PDF</button>
</div>

<table>
<thead>
<tr>
  <th>Fecha</th>
  <th>Horas</th>
  <th>Total</th>
  <th>Pendiente</th>
  <th>Abonar</th>
  <th>Historial</th>
  <th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total">
  Total a deber: ‚Ç°<span id="totalDebe">0</span>
</div>

<script>
let registros = JSON.parse(localStorage.getItem("horas")) || [];

const calcularHoras=(i,s)=>{
  const [hi,mi]=i.split(":").map(Number);
  const [hs,ms]=s.split(":").map(Number);
  return ((hs*60+ms)-(hi*60+mi))/60;
};

const fechaBonita=f=>new Date(f).toLocaleDateString("es-CR",{
  weekday:"short",day:"2-digit",month:"short",year:"numeric"
});

const fechaHoy=()=>new Date().toLocaleDateString("es-CR");

function render(){
  tabla.innerHTML="";
  let total=0;
  const filtrar=soloPendientes.checked;

  registros.forEach((r,i)=>{
    if(filtrar && r.pendiente===0) return;

    total+=r.pendiente;

    tabla.innerHTML+=`
      <tr>
        <td>${fechaBonita(r.fecha)}</td>
        <td>${r.horas.toFixed(2)}</td>
        <td>‚Ç°${r.total}</td>
        <td class="${r.pendiente===0?'pago':''}">
          ${r.pendiente===0?'PAGADO':'‚Ç°'+r.pendiente}
        </td>
        <td>
          <input type="number" min="0" placeholder="‚Ç°"
            onkeydown="if(event.key==='Enter') abonar(${i},this)">
        </td>
        <td class="historial">
          ${r.abonos.map(a=>`${a.fecha}: ‚Ç°${a.monto}`).join("<br>")}
        </td>
        <td>
          <button onclick="editar(${i})">‚úèÔ∏è</button>
          <button class="danger" onclick="eliminar(${i})">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  });

  totalDebe.textContent=total;
  localStorage.setItem("horas",JSON.stringify(registros));
}

form.onsubmit=e=>{
  e.preventDefault();

  const horas=calcularHoras(inicio.value,salida.value);
  const total=Math.round(horas*valorHora.value);

  const data={
    fecha:fecha.value,
    inicio:inicio.value,
    salida:salida.value,
    detalle:detalle.value,
    horas,
    total,
    pendiente:total,
    abonos:[]
  };

  if(editIndex.value===""){
    registros.push(data);
  }else{
    registros[editIndex.value]=data;
    editIndex.value="";
  }

  form.reset();
  render();
};

function abonar(i,input){
  let monto=Number(input.value);
  if(!monto || monto<=0) return;

  if(monto>registros[i].pendiente){
    monto=registros[i].pendiente;
  }

  registros[i].pendiente-=monto;
  registros[i].abonos.push({
    fecha:fechaHoy(),
    monto
  });

  input.value="";
  render();
}

function editar(i){
  const r=registros[i];
  fecha.value=r.fecha;
  inicio.value=r.inicio;
  salida.value=r.salida;
  detalle.value=r.detalle;
  valorHora.value=r.total/r.horas;
  editIndex.value=i;
  scrollTo({top:0,behavior:"smooth"});
}

function eliminar(i){
  if(confirm("¬øEliminar este trabajo?")){
    registros.splice(i,1);
    render();
  }
}

function exportarExcel(){
  const datos=registros.map(r=>({
    Fecha:fechaBonita(r.fecha),
    Horas:r.horas,
    Total:r.total,
    Pendiente:r.pendiente,
    Abonos:r.abonos.map(a=>`${a.fecha} ‚Ç°${a.monto}`).join(" | ")
  }));
  const ws=XLSX.utils.json_to_sheet(datos);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Horas");
  XLSX.writeFile(wb,"horas_trabajo.xlsx");
}

function exportarPDF(){
  const pdf=new jspdf.jsPDF();
  let y=10;
  pdf.text("Control de Horas",10,y); y+=10;

  registros.forEach(r=>{
    pdf.text(
      `${fechaBonita(r.fecha)} - Pendiente ‚Ç°${r.pendiente}`,
      10,y
    );
    y+=6;
    r.abonos.forEach(a=>{
      pdf.text(`  ‚Ä¢ ${a.fecha}: ‚Ç°${a.monto}`,12,y);
      y+=6;
    });
    if(y>280){pdf.addPage();y=10}
  });

  pdf.save("horas_trabajo.pdf");
}

render();
</script>

</body>
</html>
