<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Horas</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:system-ui;background:#f2f2f2;padding:10px}
h2{text-align:center}
form, table, .card{
  background:#fff;padding:10px;border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);margin-bottom:12px
}
label{font-weight:600;font-size:14px}
input, textarea, button{
  width:100%;padding:8px;margin:5px 0;border-radius:6px;border:1px solid #ccc
}
button{background:#007bff;color:#fff;font-weight:bold;border:none}
button.danger{background:#dc3545}
button.sec{background:#28a745}
button.small{padding:4px 6px;font-size:12px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid #ddd;padding:6px;text-align:center}
th{background:#eee}
.total{font-size:18px;font-weight:bold;text-align:right}
.abono{
  border:1px solid #ddd;
  border-radius:6px;
  padding:5px;
  margin-bottom:5px;
  font-size:12px;
}
.abono input{
  font-size:12px;
  padding:4px;
}
.abono-actions{
  display:flex;
  gap:4px;
  margin-top:4px;
}
</style>
</head>

<body>

<h2>‚è±Ô∏è Control de Horas</h2>

<form id="form">
  <input type="hidden" id="editIndex">

  <label>Fecha</label>
  <input type="date" id="fecha" required>

  <label>Hora Inicio</label>
  <input type="time" id="inicio" required>

  <label>Hora Salida</label>
  <input type="time" id="salida" required>

  <label>Detalle</label>
  <textarea id="detalle" placeholder="Tarea Planeamiento de Noviembre 2025"></textarea>

  <label>Valor por Hora (‚Ç°)</label>
  <input type="number" id="valorHora" value="2000">

  <button type="submit">üíæ Guardar Registro</button>
</form>

<table>
<thead>
<tr>
  <th>Fecha</th>
  <th>Horas</th>
  <th>Monto</th>
  <th>Abonos</th>
  <th>Debe</th>
  <th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total">
  Total a deber: ‚Ç°<span id="totalDebe">0</span>
</div>

<script>
let registros = JSON.parse(localStorage.getItem("horas")) || [];

function calcularHoras(i,s){
  const [hi,mi]=i.split(":").map(Number);
  const [hs,ms]=s.split(":").map(Number);
  return ((hs*60+ms)-(hi*60+mi))/60;
}

function fechaBonita(f){
  return new Date(f).toLocaleDateString("es-CR",
    {weekday:"short",day:"2-digit",month:"short",year:"numeric"});
}

function render(){
  const tabla=document.getElementById("tabla");
  tabla.innerHTML="";
  let totalGeneral=0;

  registros.forEach((r,i)=>{
    r.totalAbonos=r.abonos.reduce((s,a)=>s+a.monto,0);
    r.debe=r.monto-r.totalAbonos;
    totalGeneral+=r.debe;

    tabla.innerHTML+=`
      <tr>
        <td>${fechaBonita(r.fecha)}</td>
        <td>${r.horas.toFixed(2)}</td>
        <td>‚Ç°${r.monto}</td>
        <td>
          ${r.abonos.map((a,j)=>`
            <div class="abono">
              <input type="date" value="${a.fecha}"
                onchange="editarAbono(${i},${j},'fecha',this.value)">
              <input type="number" value="${a.monto}"
                onchange="editarAbono(${i},${j},'monto',this.value)">
              <input type="text" placeholder="Nota"
                value="${a.nota}"
                onchange="editarAbono(${i},${j},'nota',this.value)">
              <div class="abono-actions">
                <button class="danger small" onclick="delAbono(${i},${j})">‚úñ</button>
              </div>
            </div>
          `).join("")}
          <button class="small sec" onclick="addAbono(${i})">‚ûï Abono</button>
        </td>
        <td><b>‚Ç°${r.debe}</b></td>
        <td>
          <button class="small" onclick="editar(${i})">‚úèÔ∏è</button>
          <button class="small danger" onclick="eliminar(${i})">üóëÔ∏è</button>
        </td>
      </tr>`;
  });

  totalDebe.textContent=totalGeneral;
  localStorage.setItem("horas",JSON.stringify(registros));
}

form.addEventListener("submit",e=>{
  e.preventDefault();

  const data={
    fecha:fecha.value,
    inicio:inicio.value,
    salida:salida.value,
    detalle:detalle.value,
    valorHora:+valorHora.value,
    abonos: editIndex.value==="" ? [] : registros[editIndex.value].abonos
  };

  data.horas=calcularHoras(data.inicio,data.salida);
  data.monto=Math.round(data.horas*data.valorHora);

  if(editIndex.value==="") registros.push(data);
  else registros[editIndex.value]=data;

  editIndex.value="";
  e.target.reset();
  render();
});

function editar(i){
  const r=registros[i];
  fecha.value=r.fecha;
  inicio.value=r.inicio;
  salida.value=r.salida;
  detalle.value=r.detalle;
  valorHora.value=r.valorHora;
  editIndex.value=i;
  scrollTo({top:0,behavior:"smooth"});
}

function eliminar(i){
  if(confirm("¬øEliminar registro completo?")){
    registros.splice(i,1);
    render();
  }
}

function addAbono(i){
  registros[i].abonos.push({
    fecha:new Date().toISOString().slice(0,10),
    monto:0,
    nota:""
  });
  render();
}

function editarAbono(i,j,campo,valor){
  if(campo==="monto") valor=Number(valor);
  registros[i].abonos[j][campo]=valor;
  render();
}

function delAbono(i,j){
  registros[i].abonos.splice(j,1);
  render();
}

render();
</script>

</body>
</html>
