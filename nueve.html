<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Horas de Trabajo</title>

<!-- Librer√≠as para exportar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family: system-ui, Arial, sans-serif;
  background:#f2f2f2;
  margin:0;
  padding:10px;
}
h2{text-align:center}
form, table, .acciones{
  background:#fff;
  padding:10px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
  margin-bottom:12px;
}
label{font-size:14px;font-weight:600}
input, textarea, button{
  width:100%;
  padding:8px;
  margin:5px 0 10px;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  background:#007bff;
  color:#fff;
  font-weight:bold;
  border:none;
}
button.sec{background:#28a745}
button.danger{background:#dc3545}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th, td{
  border-bottom:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{background:#eee}
.total{
  font-size:18px;
  font-weight:bold;
  text-align:right;
}
.acciones button{
  margin-bottom:6px;
}
</style>
</head>

<body>

<h2>‚è±Ô∏è Control de Horas</h2>

<form id="form">
  <input type="hidden" id="editIndex">

  <label>Fecha</label>
  <input type="date" id="fecha" required>

  <label>Hora Inicio</label>
  <input type="time" id="inicio" required>

  <label>Hora Salida</label>
  <input type="time" id="salida" required>

  <label>Detalle</label>
  <textarea id="detalle" placeholder="Tarea Planeamiento de Noviembre 2025"></textarea>

  <label>Valor por Hora (‚Ç°)</label>
  <input type="number" id="valorHora" value="2000">

  <label>Abonos (‚Ç°)</label>
  <input type="number" id="abonos" value="0">

  <button type="submit">üíæ Guardar</button>
</form>

<div class="acciones">
  <button class="sec" onclick="exportarExcel()">üìä Exportar a Excel</button>
  <button class="sec" onclick="exportarPDF()">üìÑ Exportar a PDF</button>
</div>

<table>
<thead>
<tr>
  <th>Fecha</th>
  <th>Horas</th>
  <th>Monto</th>
  <th>Abonos</th>
  <th>Debe</th>
  <th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="total">
  Total a deber: ‚Ç°<span id="totalDebe">0</span>
</div>

<script>
let registros = JSON.parse(localStorage.getItem("horas")) || [];

function calcularHoras(i, s){
  const [hi, mi] = i.split(":").map(Number);
  const [hs, ms] = s.split(":").map(Number);
  return ((hs*60+ms)-(hi*60+mi))/60;
}

function fechaBonita(fecha){
  return new Date(fecha).toLocaleDateString("es-CR",{
    weekday:"short", day:"2-digit", month:"short", year:"numeric"
  });
}

function render(){
  const tabla = document.getElementById("tabla");
  tabla.innerHTML="";
  let total=0;

  registros.forEach((r,i)=>{
    total+=r.debe;
    tabla.innerHTML+=`
      <tr>
        <td>${fechaBonita(r.fecha)}</td>
        <td>${r.horas.toFixed(2)}</td>
        <td>‚Ç°${r.monto}</td>
        <td>‚Ç°${r.abonos}</td>
        <td><b>‚Ç°${r.debe}</b></td>
        <td>
          <button onclick="editar(${i})">‚úèÔ∏è</button>
          <button class="danger" onclick="eliminar(${i})">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  });

  document.getElementById("totalDebe").textContent=total;
  localStorage.setItem("horas",JSON.stringify(registros));
}

document.getElementById("form").addEventListener("submit",e=>{
  e.preventDefault();

  const data={
    fecha:fecha.value,
    inicio:inicio.value,
    salida:salida.value,
    detalle:detalle.value,
    valorHora:+valorHora.value,
    abonos:+abonos.value
  };

  data.horas=calcularHoras(data.inicio,data.salida);
  data.monto=Math.round(data.horas*data.valorHora);
  data.debe=data.monto-data.abonos;

  if(editIndex.value===""){
    registros.push(data);
  }else{
    registros[editIndex.value]=data;
    editIndex.value="";
  }

  e.target.reset();
  render();
});

function editar(i){
  const r=registros[i];
  fecha.value=r.fecha;
  inicio.value=r.inicio;
  salida.value=r.salida;
  detalle.value=r.detalle;
  valorHora.value=r.valorHora;
  abonos.value=r.abonos;
  editIndex.value=i;
  window.scrollTo({top:0,behavior:"smooth"});
}

function eliminar(i){
  if(confirm("¬øEliminar este registro?")){
    registros.splice(i,1);
    render();
  }
}

function exportarExcel(){
  const ws=XLSX.utils.json_to_sheet(registros);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Horas");
  XLSX.writeFile(wb,"horas_trabajo.xlsx");
}

function exportarPDF(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=10;
  pdf.text("Control de Horas de Trabajo",10,y);
  y+=10;

  registros.forEach(r=>{
    pdf.text(
      `${fechaBonita(r.fecha)} | Horas:${r.horas.toFixed(2)} | Debe: ‚Ç°${r.debe}`,
      10,y
    );
    y+=8;
    if(y>280){pdf.addPage();y=10;}
  });

  pdf.save("horas_trabajo.pdf");
}

render();
</script>

</body>
</html>
