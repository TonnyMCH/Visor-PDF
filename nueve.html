<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Control de Horas</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<style>
body{font-family:system-ui;background:#f5f5f5;margin:0;padding:10px}
h2{margin-top:0}
input,button{padding:8px;width:100%;margin:4px 0}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ccc;padding:5px;text-align:center}
th{background:#eee}
.pendiente{background:#ffe0e0}
.pagado{background:#e0ffe0}
</style>
</head>

<body>

<h2>üïí Control de Horas</h2>

<input type="date" id="fecha">
<input type="time" id="inicio">
<input type="time" id="salida">
<input type="text" id="detalle" placeholder="Detalle del trabajo">
<input type="number" id="valorHora" placeholder="‚Ç° por hora">
<input type="number" id="abono" placeholder="Abono ‚Ç°">

<button onclick="agregar()">‚ûï Agregar</button>

<label>
<input type="checkbox" id="soloPendientes" onchange="render()"> Solo pendientes
</label>

<h3>Total a deber: ‚Ç°<span id="totalDebe">0</span></h3>

<table>
<thead>
<tr>
<th>Fecha</th>
<th>Horas</th>
<th>Monto</th>
<th>Abonos</th>
<th>Debe</th>
<th>‚ùå</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<script>
let db, registros=[];

/* ---------- IndexedDB ---------- */
function abrirDB(){
 return new Promise((res,rej)=>{
  const r=indexedDB.open("HorasDB",1);
  r.onupgradeneeded=e=>{
   const db=e.target.result;
   db.createObjectStore("registros",{keyPath:"id",autoIncrement:true});
  };
  r.onsuccess=e=>{db=e.target.result;res();}
  r.onerror=()=>rej();
 });
}

function guardarDB(){
 const tx=db.transaction("registros","readwrite");
 const st=tx.objectStore("registros");
 st.clear();
 registros.forEach(r=>st.add(r));
}

function cargarDB(){
 return new Promise(res=>{
  const tx=db.transaction("registros","readonly");
  const st=tx.objectStore("registros");
  const r=st.getAll();
  r.onsuccess=()=>res(r.result||[]);
 });
}

/* ---------- App ---------- */
(async()=>{
 await abrirDB();
 if(navigator.storage?.persist) navigator.storage.persist();
 registros=await cargarDB();
 render();
})();

function horas(inicio,salida){
 const a=new Date("1970-01-01T"+inicio);
 const b=new Date("1970-01-01T"+salida);
 return (b-a)/3600000;
}

function agregar(){
 const f=fecha.value;
 const i=inicio.value;
 const s=salida.value;
 const d=detalle.value;
 const v=+valorHora.value;
 const a=+abono.value||0;
 if(!f||!i||!s||!v)return;

 const h=horas(i,s);
 const monto=h*v;
 registros.push({
  fecha:f,detalle:d,horas:h,
  monto:monto,abonos:[{fecha:new Date().toISOString(),monto:a}]
 });
 guardarDB();
 render();
}

function eliminar(i){
 registros.splice(i,1);
 guardarDB();
 render();
}

function render(){
 const t=document.getElementById("tabla");
 t.innerHTML="";
 let total=0;
 const solo=soloPendientes.checked;

 registros.forEach((r,i)=>{
  const abonado=r.abonos.reduce((s,a)=>s+a.monto,0);
  const debe=r.monto-abonado;
  if(solo && debe<=0)return;
  total+=debe>0?debe:0;

  const tr=document.createElement("tr");
  tr.className=debe>0?"pendiente":"pagado";
  tr.innerHTML=`
   <td>${new Date(r.fecha).toLocaleDateString("es-CR",{weekday:"short",day:"2-digit",month:"short",year:"numeric"})}</td>
   <td>${r.horas}</td>
   <td>‚Ç°${r.monto}</td>
   <td>‚Ç°${abonado}</td>
   <td>‚Ç°${debe}</td>
   <td><button onclick="eliminar(${i})">‚ùå</button></td>
  `;
  t.appendChild(tr);
 });
 totalDebe.textContent=total;
}
</script>

<script>
if("serviceWorker"in navigator){
 navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
