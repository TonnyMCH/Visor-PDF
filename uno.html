<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sellar Imagen en PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>

    <style>
        #whatsappBtn {
            display: none;
            margin-top: 20px;
            background: #25D366;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
    </style>

</head>
<body>
    <h2>Sellar PDF con imagen</h2>

    <p><b>Subir PDF</b></p>
    <input type="file" id="pdfInput" accept="application/pdf">

    <p><b>Subir sello PNG</b></p>
    <input type="file" id="imageInput" accept="image/png">

    <p>
        <label>
            <input type="checkbox" id="usarPredeterminado" onchange="toggleImageInput()">
            Usar sello predeterminado
        </label>
    </p>

    <p>
        <b>TamaÃ±o del sello</b> (en cm)<br>
        Alto (cm): <input type="number" id="sizeCM" value="4" step="0.1">
    </p>

    <button onclick="processPDF()">Procesar PDF</button>

    <!-- BOTÃ“N WHATSAPP -->
    <button id="whatsappBtn" onclick="shareWhatsApp()">ðŸ“¤ Compartir por WhatsApp</button>

    <script>
        let lastPDFBlob = null;

        function toggleImageInput() {
            const check = document.getElementById("usarPredeterminado").checked;
            const imageInput = document.getElementById("imageInput");

            imageInput.disabled = check;
            imageInput.style.opacity = check ? "0.5" : "1";
        }

        async function processPDF() {
            const pdfFile = document.getElementById('pdfInput').files[0];
            const usarPredeterminado = document.getElementById('usarPredeterminado').checked;
            const imagenSubida = document.getElementById('imageInput').files[0];

            if (!pdfFile) {
                alert('Por favor sube un PDF.');
                return;
            }

            const pdfBytes = await pdfFile.arrayBuffer();
            const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
            const firstPage = pdfDoc.getPages()[0];

            let imageBytes;

            if (usarPredeterminado) {
                const response = await fetch("imagenes/sello.png");
                imageBytes = await response.arrayBuffer();
            } else {
                if (!imagenSubida) {
                    alert("Sube una imagen o marca sello predeterminado.");
                    return;
                }
                imageBytes = await imagenSubida.arrayBuffer();
            }

            const pngImage = await pdfDoc.embedPng(imageBytes);
            const imageDims = pngImage.scale(1);

            const heightCM = parseFloat(document.getElementById("sizeCM").value);
            const heightPT = heightCM * 28.35;
            const widthPT = (imageDims.width / imageDims.height) * heightPT;

            const pageWidth = firstPage.getWidth();
            const pageHeight = firstPage.getHeight();
            const margin = 20;

            // POSICIÃ“N ARRIBA A LA DERECHA
            const posX = pageWidth - widthPT - margin;
            const posY = pageHeight - heightPT - margin;

            firstPage.drawImage(pngImage, {
                x: posX,
                y: posY,
                width: widthPT,
                height: heightPT
            });

            const modifiedPdfBytes = await pdfDoc.save();
            const blob = new Blob([modifiedPdfBytes], { type: "application/pdf" });

            lastPDFBlob = blob;

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'pdf_sellado.pdf';
            link.click();

            // Mostrar botÃ³n WhatsApp
            document.getElementById("whatsappBtn").style.display = "block";
        }

        async function shareWhatsApp() {
            if (!lastPDFBlob) {
                alert("Primero genera el PDF.");
                return;
            }

            const file = new File([lastPDFBlob], "pdf_sellado.pdf", { type: "application/pdf" });

            // âœ” Primero intentamos "navigator.share"
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: "PDF Sellado",
                    text: "Te envÃ­o el PDF sellado."
                });
                return;
            }

            // âœ” Si NO es compatible, enviar link a WhatsApp Web
            const url = encodeURIComponent("AquÃ­ estÃ¡ el PDF sellado.");
            window.open("https://wa.me/?text=" + url, "_blank");
        }
    </script>

</body>
</html>
