<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Seis - Personas y Grupos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="imagenes/imagen6.png" type="image/png">

    <style>
        body {
            margin: 0;
            font-family: system-ui, Arial, sans-serif;
            background: #111;
            color: #fff;
            padding: 15px;
        }

        h2, h3 {
            text-align: center;
        }

        form, .acciones, .grupos-box, .filtros {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border-radius: 8px;
            border: none;
            font-size: 15px;
        }

        input, select {
            background: #2a2a2a;
            color: #fff;
        }

        button {
            font-weight: bold;
            cursor: pointer;
        }

        .guardar {
            background: #4caf50;
            color: #000;
        }

        .grupo-btn {
            background: #03a9f4;
            color: #000;
        }

        .ordenar {
            background: #9c27b0;
            color: #fff;
        }

        .exportar {
            background: #2196f3;
            color: #fff;
        }

        .editar {
            background: #ffc107;
            color: #000;
        }

        .eliminar {
            background: #f44336;
            color: #fff;
        }

        .card {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 4px solid #4caf50;
        }

        .acciones-card {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        span {
            color: #4caf50;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h2 id="titulo">Agregar Persona</h2>

<form id="form">
  <input type="hidden" id="index">
  <input type="text" id="id" placeholder="ID" required>
  <input type="text" id="nombre" placeholder="Nombre" required>
  <input type="date" id="nacimiento" required>
  <select id="grupo" required></select>
  <button class="guardar" type="submit">Guardar</button>
</form>

<div class="grupos-box">
  <h3>Crear grupo</h3>
  <input type="text" id="nuevoGrupo" placeholder="Ej: Amigos, Familia">
  <button class="grupo-btn" onclick="agregarGrupo()">‚ûï Agregar grupo</button>
</div>

<div class="filtros">
  <h3>Filtrar / Buscar</h3>
  <select id="filtroGrupo" onchange="aplicarFiltros()">
    <option value="">Todos los grupos</option>
  </select>
  <input type="text" id="busqueda" placeholder="Buscar por nombre o ID" oninput="aplicarFiltros()">
</div>

<div class="acciones">
  <button class="ordenar" onclick="ordenarPorEdad()">üîΩ Ordenar por edad (Mayor ‚Üí Menor)</button>
  <button class="exportar" onclick="exportarJSON()">üì§ Exportar JSON</button>
  <input type="file" id="importar" accept=".json">
</div>

<h2>Personas</h2>
<div id="lista"></div>

<script>
  const lista = document.getElementById("lista");
  const selectGrupo = document.getElementById("grupo");
  const filtroGrupo = document.getElementById("filtroGrupo");
  const titulo = document.getElementById("titulo");

  function calcularEdad(fecha) {
    const hoy = new Date();
    const p = fecha.split("-");
    const nac = new Date(p[0], p[1] - 1, p[2]);
    let edad = hoy.getFullYear() - nac.getFullYear();
    const m = hoy.getMonth() - nac.getMonth();
    if (m < 0 || (m === 0 && hoy.getDate() < nac.getDate())) edad--;
    return edad;
  }

  function nombreMes(m) {
    return ["enero","febrero","marzo","abril","mayo","junio","julio",
            "agosto","septiembre","octubre","noviembre","diciembre"][m];
  }

  function proximoCumple(fecha) {
    const hoy = new Date();
    hoy.setHours(0,0,0,0);

    const p = fecha.split("-");
    const mes = parseInt(p[1]) - 1;
    const dia = parseInt(p[2]);

    let proximo = new Date(hoy.getFullYear(), mes, dia);
    proximo.setHours(0,0,0,0);

    if (proximo < hoy) proximo.setFullYear(hoy.getFullYear() + 1);

    return `${dia} de ${nombreMes(mes)} de ${proximo.getFullYear()}`;
  }

  function diasParaCumple(fecha) {
    const hoy = new Date();
    hoy.setHours(0,0,0,0);

    const p = fecha.split("-");
    let proximo = new Date(hoy.getFullYear(), p[1] - 1, p[2]);
    proximo.setHours(0,0,0,0);

    if (proximo < hoy) proximo.setFullYear(hoy.getFullYear() + 1);

    return Math.round((proximo - hoy) / (1000 * 60 * 60 * 24));
  }

  function verificarAlertas() {
    const personas = obtenerPersonas();
    if (!personas.length) return;

    let hoyArr = [], mananaArr = [], proximos = [];

    personas.forEach(p => {
      const d = diasParaCumple(p.nacimiento);
      if (d === 0) hoyArr.push(p.nombre);
      else if (d === 1) mananaArr.push(p.nombre);
      else if (d > 1 && d <= 30) proximos.push(`${p.nombre} (${d} d√≠as)`);
    });

    let msg = "";
    if (hoyArr.length) msg += "üéâ HOY cumplen a√±os:\n‚Ä¢ " + hoyArr.join("\n‚Ä¢ ") + "\n\n";
    if (mananaArr.length) msg += "‚è∞ MA√ëANA cumplen a√±os:\n‚Ä¢ " + mananaArr.join("\n‚Ä¢ ") + "\n\n";
    if (proximos.length) msg += "üìÖ Pr√≥ximos 30 d√≠as:\n‚Ä¢ " + proximos.join("\n‚Ä¢ ");

    if (msg) alert(msg);
  }

  function obtenerPersonas() {
    return JSON.parse(localStorage.getItem("personas")) || [];
  }

  function obtenerGrupos() {
    return JSON.parse(localStorage.getItem("grupos")) || [];
  }

  function guardarPersonas(p) {
    localStorage.setItem("personas", JSON.stringify(p));
  }

  function guardarGrupos(g) {
    localStorage.setItem("grupos", JSON.stringify(g));
    cargarSelectGrupos();
    cargarFiltroGrupos();
  }

  function cargarSelectGrupos() {
    selectGrupo.innerHTML = `<option value="">Seleccionar grupo</option>`;
    obtenerGrupos().forEach(g => selectGrupo.innerHTML += `<option>${g}</option>`);
  }

  function cargarFiltroGrupos() {
    filtroGrupo.innerHTML = `<option value="">Todos los grupos</option>`;
    obtenerGrupos().forEach(g => filtroGrupo.innerHTML += `<option>${g}</option>`);
  }

  function agregarGrupo() {
    const g = nuevoGrupo.value.trim();
    if (!g) return alert("Nombre requerido");
    const grupos = obtenerGrupos();
    if (grupos.includes(g)) return alert("El grupo ya existe");
    grupos.push(g);
    guardarGrupos(grupos);
    nuevoGrupo.value = "";
  }

  function aplicarFiltros() {
    const txt = busqueda.value.toLowerCase();
    const g = filtroGrupo.value;

    let p = obtenerPersonas();
    if (g) p = p.filter(x => x.grupo === g);
    if (txt) p = p.filter(x => x.nombre.toLowerCase().includes(txt) || x.id.includes(txt));

    mostrar(p);
  }

  function mostrar(personas) {
    lista.innerHTML = "";
    personas.forEach(p => {
      lista.innerHTML += `
        <div class="card">
          <p>ID: <span>${p.id}</span></p>
          <p>Nombre: <span>${p.nombre}</span></p>
          <p>Grupo: <span>${p.grupo}</span></p>
          <p>Edad: <span>${calcularEdad(p.nacimiento)}</span> a√±os</p>
          <p>üéÇ Pr√≥ximo cumplea√±os: <span>${proximoCumple(p.nacimiento)}</span></p>
          <div class="acciones-card">
            <button class="editar" onclick="editar('${p.id}')">‚úèÔ∏è Editar</button>
            <button class="eliminar" onclick="eliminar('${p.id}')">üóëÔ∏è Eliminar</button>
          </div>
        </div>`;
    });
  }

  form.onsubmit = e => {
    e.preventDefault();
    const personas = obtenerPersonas();
    const i = index.value;
    const p = { id: id.value, nombre: nombre.value, nacimiento: nacimiento.value, grupo: grupo.value };
    i === "" ? personas.push(p) : personas[i] = p;
    guardarPersonas(personas);
    form.reset(); index.value = "";
    titulo.textContent = "Agregar Persona";
    aplicarFiltros();
  };

  function editar(idB) {
    const p = obtenerPersonas();
    const i = p.findIndex(x => x.id === idB);
    index.value = i;
    id.value = p[i].id;
    nombre.value = p[i].nombre;
    nacimiento.value = p[i].nacimiento;
    grupo.value = p[i].grupo;
    titulo.textContent = "Editar Persona";
    window.scrollTo({top:0,behavior:"smooth"});
  }

  function eliminar(idB) {
    if (!confirm("¬øEliminar persona?")) return;
    guardarPersonas(obtenerPersonas().filter(p => p.id !== idB));
    aplicarFiltros();
  }

  function ordenarPorEdad() {
    const p = obtenerPersonas();
    p.sort((a,b)=>calcularEdad(b.nacimiento)-calcularEdad(a.nacimiento));
    guardarPersonas(p);
    aplicarFiltros();
  }

  function exportarJSON() {
    const blob = new Blob([JSON.stringify({grupos:obtenerGrupos(),personas:obtenerPersonas()},null,2)],{type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "personas.json";
    a.click();
  }

  importar.onchange = e => {
    const r = new FileReader();
    r.onload = () => {
      const d = JSON.parse(r.result);
      guardarGrupos(d.grupos||[]);
      guardarPersonas(d.personas||[]);
      aplicarFiltros();
    };
    r.readAsText(e.target.files[0]);
  };

  cargarSelectGrupos();
  cargarFiltroGrupos();
  aplicarFiltros();
  setTimeout(verificarAlertas, 600);
</script>

</body>
</html>
