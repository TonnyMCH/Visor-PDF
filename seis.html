<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Personas y Grupos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: system-ui, Arial, sans-serif;
      background: #111;
      color: #fff;
      padding: 15px;
    }

    h2, h3 { text-align: center; }

    form, .acciones, .grupos-box, .filtros {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      border: none;
      font-size: 15px;
    }

    input, select {
      background: #2a2a2a;
      color: #fff;
    }

    button { font-weight: bold; cursor: pointer; }

    .guardar { background: #4caf50; color: #000; }
    .grupo-btn { background: #03a9f4; color: #000; }
    .ordenar { background: #9c27b0; color: #fff; }
    .exportar { background: #2196f3; color: #fff; }
    .editar { background: #ffc107; color: #000; }
    .eliminar { background: #f44336; color: #fff; }

    .grupo {
      margin-bottom: 20px;
      border-top: 2px solid #333;
      padding-top: 10px;
    }

    .card {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .acciones-card {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    span {
      color: #4caf50;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2 id="titulo">Agregar Persona</h2>

<form id="form">
  <input type="hidden" id="index">
  <input type="text" id="id" placeholder="ID" required>
  <input type="text" id="nombre" placeholder="Nombre" required>
  <input type="date" id="nacimiento" required>
  <select id="grupo" required></select>
  <button class="guardar" type="submit">Guardar</button>
</form>

<div class="grupos-box">
  <h3>Crear grupo</h3>
  <input type="text" id="nuevoGrupo" placeholder="Ej: Familia, Trabajo">
  <button class="grupo-btn" onclick="agregarGrupo()">‚ûï Agregar grupo</button>
</div>

<div class="filtros">
  <h3>Filtrar / Buscar</h3>
  <select id="filtroGrupo" onchange="aplicarFiltros()">
    <option value="">Todos los grupos</option>
  </select>
  <input type="text" id="busqueda" placeholder="Buscar por nombre o ID" oninput="aplicarFiltros()">
</div>

<div class="acciones">
  <button class="ordenar" onclick="ordenarPorEdad()">üîΩ Ordenar por edad (Mayor ‚Üí Menor)</button>
  <button class="exportar" onclick="exportarJSON()">üì§ Exportar JSON</button>
  <input type="file" id="importar" accept=".json">
</div>

<h2>Resultados</h2>
<div id="lista"></div>

<script>
  const lista = document.getElementById("lista");
  const selectGrupo = document.getElementById("grupo");
  const filtroGrupo = document.getElementById("filtroGrupo");
  const titulo = document.getElementById("titulo");

  function calcularEdad(fecha) {
    const hoy = new Date();
    const nac = new Date(fecha);
    let edad = hoy.getFullYear() - nac.getFullYear();
    const m = hoy.getMonth() - nac.getMonth();
    if (m < 0 || (m === 0 && hoy.getDate() < nac.getDate())) edad--;
    return edad;
  }

  function obtenerPersonas() {
    return JSON.parse(localStorage.getItem("personas")) || [];
  }

  function obtenerGrupos() {
    return JSON.parse(localStorage.getItem("grupos")) || [];
  }

  function guardarPersonas(p) {
    localStorage.setItem("personas", JSON.stringify(p));
  }

  function guardarGrupos(g) {
    localStorage.setItem("grupos", JSON.stringify(g));
    cargarSelectGrupos();
    cargarFiltroGrupos();
  }

  function cargarSelectGrupos() {
    selectGrupo.innerHTML = `<option value="">Seleccionar grupo</option>`;
    obtenerGrupos().forEach(g => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = g;
      selectGrupo.appendChild(opt);
    });
  }

  function cargarFiltroGrupos() {
    filtroGrupo.innerHTML = `<option value="">Todos los grupos</option>`;
    obtenerGrupos().forEach(g => {
      const opt = document.createElement("option");
      opt.value = opt.textContent = g;
      filtroGrupo.appendChild(opt);
    });
  }

  function agregarGrupo() {
    const nombreGrupo = nuevoGrupo.value.trim();
    if (!nombreGrupo) return alert("Nombre del grupo requerido");
    const grupos = obtenerGrupos();
    if (grupos.includes(nombreGrupo)) return alert("El grupo ya existe");
    grupos.push(nombreGrupo);
    guardarGrupos(grupos);
    nuevoGrupo.value = "";
  }

  function aplicarFiltros() {
    const texto = busqueda.value.toLowerCase();
    const grupoSel = filtroGrupo.value;

    let personas = obtenerPersonas();

    if (grupoSel) personas = personas.filter(p => p.grupo === grupoSel);
    if (texto)
      personas = personas.filter(p =>
        p.nombre.toLowerCase().includes(texto) ||
        p.id.includes(texto)
      );

    mostrarResultados(personas);
  }

  function mostrarResultados(personas) {
    lista.innerHTML = "";
    personas.forEach(p => {
      const edad = calcularEdad(p.nacimiento);
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <p>ID: <span>${p.id}</span></p>
        <p>Nombre: <span>${p.nombre}</span></p>
        <p>Grupo: <span>${p.grupo}</span></p>
        <p>Edad: <span>${edad}</span> a√±os</p>
        <div class="acciones-card">
          <button class="editar" onclick="editar('${p.id}')">‚úèÔ∏è Editar</button>
          <button class="eliminar" onclick="eliminar('${p.id}')">üóëÔ∏è Eliminar</button>
        </div>
      `;
      lista.appendChild(div);
    });
  }

  form.addEventListener("submit", e => {
    e.preventDefault();
    const personas = obtenerPersonas();
    const i = index.value;

    const persona = {
      id: id.value.trim(),
      nombre: nombre.value.trim(),
      nacimiento: nacimiento.value,
      grupo: grupo.value
    };

    if (i === "") personas.push(persona);
    else {
      personas[i] = persona;
      titulo.textContent = "Agregar Persona";
    }

    guardarPersonas(personas);
    form.reset();
    index.value = "";
    aplicarFiltros();
  });

  function editar(idBuscar) {
    const personas = obtenerPersonas();
    const i = personas.findIndex(p => p.id === idBuscar);
    const p = personas[i];
    index.value = i;
    id.value = p.id;
    nombre.value = p.nombre;
    nacimiento.value = p.nacimiento;
    grupo.value = p.grupo;
    titulo.textContent = "Editar Persona";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function eliminar(idBuscar) {
    if (!confirm("¬øEliminar esta persona?")) return;
    const personas = obtenerPersonas().filter(p => p.id !== idBuscar);
    guardarPersonas(personas);
    aplicarFiltros();
  }

  function ordenarPorEdad() {
    const personas = obtenerPersonas();
    personas.sort((a, b) =>
      calcularEdad(b.nacimiento) - calcularEdad(a.nacimiento)
    );
    guardarPersonas(personas);
    aplicarFiltros();
  }

  function exportarJSON() {
    const datos = JSON.stringify({
      grupos: obtenerGrupos(),
      personas: obtenerPersonas()
    }, null, 2);
    const blob = new Blob([datos], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "personas_grupos.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  importar.addEventListener("change", e => {
    const archivo = e.target.files[0];
    if (!archivo) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        guardarPersonas(data.personas);
        guardarGrupos(data.grupos);
        aplicarFiltros();
        alert("Datos importados correctamente");
      } catch {
        alert("JSON inv√°lido");
      }
    };
    reader.readAsText(archivo);
  });

  cargarSelectGrupos();
  cargarFiltroGrupos();
  aplicarFiltros();
</script>

</body>
</html>
